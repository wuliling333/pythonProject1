<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB æ•°æ®ç®¡ç†å·¥å…·</title>
    <style>
        /* ä¿ç•™åŸæœ‰æ‰€æœ‰æ ·å¼ä¸å˜ */
        /* ...åŸæœ‰CSSæ ·å¼... */

        /* æ–°å¢æ ·å¼ */
        .car-select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            background-color: #f8fafc;
        }

        .auto-fill-btn {
            margin-top: 0.5rem;
            padding: 0.5rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š MongoDB æ•°æ®ç®¡ç†å·¥å…·</h1>

        <!-- æŸ¥è¯¢éƒ¨åˆ† -->
        <div class="section">
            <div class="section-header">ğŸ” æ•°æ®æŸ¥è¯¢</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="query-uid">ç”¨æˆ·ID</label>
                    <input type="text" id="query-uid" placeholder="ä¾‹å¦‚: 10001779">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="queryData()">æ‰§è¡ŒæŸ¥è¯¢</button>
                    <button class="btn btn-primary" onclick="fillUpdateForm()" id="fill-update-btn" disabled>å¡«å……åˆ°æ›´æ–°è¡¨å•</button>
                </div>

                <div id="query-result" class="response"></div>
            </div>
        </div>

        <!-- æ›´æ–°éƒ¨åˆ† -->
        <div class="section">
            <div class="section-header">âœï¸ æ•°æ®æ›´æ–°</div>
            <div class="section-body">
                <div class="update-section">
                    <h2>ç”¨æˆ·ID</h2>
                    <div class="form-group">
                        <input type="text" id="update-uid" placeholder="ä¾‹å¦‚: 10001779">
                    </div>
                </div>

                <div class="update-section">
                    <h2>ç”¨æˆ·æ’åæ›´æ–°</h2>
                    <div class="flex-row">
                        <div class="form-group">
                            <label for="update-score">Rank Score</label>
                            <input type="number" id="update-score">
                        </div>
                        <div class="form-group">
                            <label for="update-level">Rank Level</label>
                            <input type="number" id="update-level">
                        </div>
                    </div>
                </div>

                <div class="update-section">
                    <h2>æ®¿å ‚åˆ†æ•°æ›´æ–°</h2>
                    <div id="palace-car-container">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„è½¦è¾†è¡¨å• -->
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addPalaceCar()">æ·»åŠ è½¦è¾†</button>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitCombinedUpdate()">æäº¤æ›´æ–°</button>
                </div>

                <div id="update-result" class="response"></div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ•°æ®åº“
        const mockDatabase = {
            users: {
                '10001779': {
                    uid: '10001779',
                    rank: {
                        score: 2100,
                        level: 5
                    },
                    palace: {
                        '10006': {
                            palace_scores: [85, 90, 78, 92, 88],
                            rank_score: 210,
                            season_best_rank_score: 210
                        },
                        '10007': {
                            palace_scores: [78, 82, 85, 90, 80],
                            rank_score: 195,
                            season_best_rank_score: 200
                        }
                    }
                }
            },
            cars: [
                { id: '10006', name: 'AE86' },
                { id: '10007', name: 'RX-7' },
                { id: '10008', name: 'GTR R34' },
                { id: '10009', name: 'EVO IX' }
            ]
        };

        // æ·»åŠ è½¦è¾†ä¸‹æ‹‰é€‰æ‹©
        function addPalaceCar(carId = '', scores = [], rankScore = '', seasonBestRank = '') {
            const container = document.getElementById('palace-car-container');
            const carItem = document.createElement('div');
            carItem.className = 'car-item';

            // åˆ›å»ºä¸‹æ‹‰é€‰æ‹©
            const select = document.createElement('select');
            select.className = 'car-select';
            select.innerHTML = `
                <option value="">-- é€‰æ‹©è½¦è¾† --</option>
                ${mockDatabase.cars.map(car =>
                    `<option value="${car.id}" ${car.id === carId ? 'selected' : ''}>${car.name} (${car.id})</option>`
                ).join('')}
            `;

            carItem.innerHTML = `
                <div class="form-group">
                    <label>è½¦è¾†é€‰æ‹©</label>
                    ${select.outerHTML}
                </div>

                <div class="form-group">
                    <label>æ®¿å ‚åˆ†æ•°</label>
                    <div class="palace-scores">
                        ${Array(5).fill().map((_,i) =>
                            `<input type="number" class="palace-score" placeholder="èµ›é“${i+1}"
                                   value="${scores[i] || ''}">`
                        ).join('')}
                    </div>
                </div>

                <div class="flex-row">
                    <div class="form-group">
                        <label>Rank Score</label>
                        <input type="number" class="rank-score" placeholder="ä¾‹å¦‚: 210" value="${rankScore || ''}">
                    </div>
                    <div class="form-group">
                        <label>Season Best Rank</label>
                        <input type="number" class="season-best-rank" placeholder="ä¾‹å¦‚: 210" value="${seasonBestRank || ''}">
                    </div>
                </div>

                <button class="btn btn-danger delete-btn" onclick="this.parentNode.remove()">Ã—</button>
            `;

            container.appendChild(carItem);
        }

        // æ•°æ®æŸ¥è¯¢å‡½æ•°
        async function queryData() {
            const uid = document.getElementById('query-uid').value.trim();

            if (!uid) {
                showResult('query-result', false, 'è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            try {
                const userData = mockDatabase.users[uid] || null;

                if (!userData) {
                    showResult('query-result', false, 'æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æ•°æ®');
                    return;
                }

                // å¯ç”¨å¡«å……æŒ‰é’®
                document.getElementById('fill-update-btn').disabled = false;

                // å­˜å‚¨æŸ¥è¯¢ç»“æœä¾›åç»­ä½¿ç”¨
                window.lastQueryResult = userData;

                showResult('query-result', true, {
                    uid: uid,
                    data: userData,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                showResult('query-result', false, error.message);
            }
        }

        // å¡«å……æŸ¥è¯¢ç»“æœåˆ°æ›´æ–°è¡¨å•
        function fillUpdateForm() {
            if (!window.lastQueryResult) {
                showResult('update-result', false, 'æ²¡æœ‰å¯ç”¨çš„æŸ¥è¯¢ç»“æœ');
                return;
            }

            const data = window.lastQueryResult;

            // å¡«å……ç”¨æˆ·ID
            document.getElementById('update-uid').value = data.uid;

            // å¡«å……æ’åæ•°æ®
            if (data.rank) {
                document.getElementById('update-score').value = data.rank.score || '';
                document.getElementById('update-level').value = data.rank.level || '';
            }

            // æ¸…ç©ºç°æœ‰è½¦è¾†è¡¨å•
            document.getElementById('palace-car-container').innerHTML = '';

            // å¡«å……æ®¿å ‚è½¦è¾†æ•°æ®
            if (data.palace && Object.keys(data.palace).length > 0) {
                Object.entries(data.palace).forEach(([carId, carData]) => {
                    addPalaceCar(
                        carId,
                        carData.palace_scores,
                        carData.rank_score,
                        carData.season_best_rank_score
                    );
                });
            } else {
                // å¦‚æœæ²¡æœ‰è½¦è¾†æ•°æ®ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¡¨å•
                addPalaceCar();
            }

            showResult('update-result', true, 'å·²ä»æŸ¥è¯¢ç»“æœå¡«å……æ›´æ–°è¡¨å•');
        }

        // æäº¤æ›´æ–°
        async function submitCombinedUpdate() {
            const uid = document.getElementById('update-uid').value.trim();
            const score = document.getElementById('update-score').value;
            const level = document.getElementById('update-level').value;
            const carItems = document.querySelectorAll('#palace-car-container .car-item');

            if (!uid) {
                showResult('update-result', false, 'è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            const updateData = {
                uid: uid,
                rank: {},
                palace: {}
            };

            // å¤„ç†æ’åæ›´æ–°
            if (score || level) {
                updateData.rank = {
                    score: score ? parseInt(score) : null,
                    level: level ? parseInt(level) : null
                };
            }

            // å¤„ç†æ®¿å ‚åˆ†æ•°æ›´æ–°
            if (carItems.length > 0) {
                const updates = {};
                let hasError = false;

                carItems.forEach(item => {
                    const carId = item.querySelector('.car-select').value;
                    const scores = Array.from(item.querySelectorAll('.palace-score')).map(
                        input => input.value === '' ? null : parseInt(input.value)
                    );
                    const rankScore = item.querySelector('.rank-score').value || null;
                    const seasonBestRank = item.querySelector('.season-best-rank').value || null;

                    if (!carId) {
                        showResult('update-result', false, 'è¯·é€‰æ‹©è½¦è¾†');
                        hasError = true;
                        return;
                    }

                    updates[carId] = {
                        palace_scores: scores,
                        rank_score: rankScore !== null ? parseInt(rankScore) : null,
                        season_best_rank_score: seasonBestRank !== null ? parseInt(seasonBestRank) : null
                    };
                });

                if (hasError) return;
                updateData.palace = updates;
            }

            if (Object.keys(updateData.rank).length === 0 && Object.keys(updateData.palace).length === 0) {
                showResult('update-result', false, 'è¯·è‡³å°‘å¡«å†™ä¸€é¡¹æ›´æ–°å†…å®¹');
                return;
            }

            try {
                // æ¨¡æ‹Ÿæ›´æ–°æ•°æ®åº“
                if (!mockDatabase.users[uid]) {
                    mockDatabase.users[uid] = { uid: uid };
                }

                if (updateData.rank) {
                    mockDatabase.users[uid].rank = {
                        ...mockDatabase.users[uid].rank,
                        ...updateData.rank
                    };
                }

                if (updateData.palace) {
                    if (!mockDatabase.users[uid].palace) {
                        mockDatabase.users[uid].palace = {};
                    }

                    Object.entries(updateData.palace).forEach(([carId, data]) => {
                        mockDatabase.users[uid].palace[carId] = {
                            ...mockDatabase.users[uid].palace[carId],
                            ...data
                        };
                    });
                }

                showResult('update-result', true, {
                    message: `ç”¨æˆ· ${uid} æ•°æ®æ›´æ–°æˆåŠŸï¼`,
                    updated_data: updateData,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                showResult('update-result', false, error.message);
            }
        }

        // æ˜¾ç¤ºç»“æœå‡½æ•°
        function showResult(elementId, success, data) {
            const element = document.getElementById(elementId);
            element.className = success ? 'response success' : 'response error';
            element.innerHTML = typeof data === 'string'
                ? data
                : `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // åˆå§‹åŒ–æ·»åŠ ä¸€è¾†è½¦
        document.addEventListener('DOMContentLoaded', () => {
            addPalaceCar();
        });
    </script>
</body>
</html>