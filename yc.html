<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB 数据管理工具</title>
    <style>
        /* 保留原有所有样式不变 */
        /* ...原有CSS样式... */

        /* 新增样式 */
        .car-select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            background-color: #f8fafc;
        }

        .auto-fill-btn {
            margin-top: 0.5rem;
            padding: 0.5rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 MongoDB 数据管理工具</h1>

        <!-- 查询部分 -->
        <div class="section">
            <div class="section-header">🔍 数据查询</div>
            <div class="section-body">
                <div class="form-group">
                    <label for="query-uid">用户ID</label>
                    <input type="text" id="query-uid" placeholder="例如: 10001779">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="queryData()">执行查询</button>
                    <button class="btn btn-primary" onclick="fillUpdateForm()" id="fill-update-btn" disabled>填充到更新表单</button>
                </div>

                <div id="query-result" class="response"></div>
            </div>
        </div>

        <!-- 更新部分 -->
        <div class="section">
            <div class="section-header">✏️ 数据更新</div>
            <div class="section-body">
                <div class="update-section">
                    <h2>用户ID</h2>
                    <div class="form-group">
                        <input type="text" id="update-uid" placeholder="例如: 10001779">
                    </div>
                </div>

                <div class="update-section">
                    <h2>用户排名更新</h2>
                    <div class="flex-row">
                        <div class="form-group">
                            <label for="update-score">Rank Score</label>
                            <input type="number" id="update-score">
                        </div>
                        <div class="form-group">
                            <label for="update-level">Rank Level</label>
                            <input type="number" id="update-level">
                        </div>
                    </div>
                </div>

                <div class="update-section">
                    <h2>殿堂分数更新</h2>
                    <div id="palace-car-container">
                        <!-- 动态生成的车辆表单 -->
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addPalaceCar()">添加车辆</button>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitCombinedUpdate()">提交更新</button>
                </div>

                <div id="update-result" class="response"></div>
            </div>
        </div>
    </div>

    <script>
        // 模拟数据库
        const mockDatabase = {
            users: {
                '10001779': {
                    uid: '10001779',
                    rank: {
                        score: 2100,
                        level: 5
                    },
                    palace: {
                        '10006': {
                            palace_scores: [85, 90, 78, 92, 88],
                            rank_score: 210,
                            season_best_rank_score: 210
                        },
                        '10007': {
                            palace_scores: [78, 82, 85, 90, 80],
                            rank_score: 195,
                            season_best_rank_score: 200
                        }
                    }
                }
            },
            cars: [
                { id: '10006', name: 'AE86' },
                { id: '10007', name: 'RX-7' },
                { id: '10008', name: 'GTR R34' },
                { id: '10009', name: 'EVO IX' }
            ]
        };

        // 添加车辆下拉选择
        function addPalaceCar(carId = '', scores = [], rankScore = '', seasonBestRank = '') {
            const container = document.getElementById('palace-car-container');
            const carItem = document.createElement('div');
            carItem.className = 'car-item';

            // 创建下拉选择
            const select = document.createElement('select');
            select.className = 'car-select';
            select.innerHTML = `
                <option value="">-- 选择车辆 --</option>
                ${mockDatabase.cars.map(car =>
                    `<option value="${car.id}" ${car.id === carId ? 'selected' : ''}>${car.name} (${car.id})</option>`
                ).join('')}
            `;

            carItem.innerHTML = `
                <div class="form-group">
                    <label>车辆选择</label>
                    ${select.outerHTML}
                </div>

                <div class="form-group">
                    <label>殿堂分数</label>
                    <div class="palace-scores">
                        ${Array(5).fill().map((_,i) =>
                            `<input type="number" class="palace-score" placeholder="赛道${i+1}"
                                   value="${scores[i] || ''}">`
                        ).join('')}
                    </div>
                </div>

                <div class="flex-row">
                    <div class="form-group">
                        <label>Rank Score</label>
                        <input type="number" class="rank-score" placeholder="例如: 210" value="${rankScore || ''}">
                    </div>
                    <div class="form-group">
                        <label>Season Best Rank</label>
                        <input type="number" class="season-best-rank" placeholder="例如: 210" value="${seasonBestRank || ''}">
                    </div>
                </div>

                <button class="btn btn-danger delete-btn" onclick="this.parentNode.remove()">×</button>
            `;

            container.appendChild(carItem);
        }

        // 数据查询函数
        async function queryData() {
            const uid = document.getElementById('query-uid').value.trim();

            if (!uid) {
                showResult('query-result', false, '请输入用户ID');
                return;
            }

            try {
                const userData = mockDatabase.users[uid] || null;

                if (!userData) {
                    showResult('query-result', false, '未找到该用户数据');
                    return;
                }

                // 启用填充按钮
                document.getElementById('fill-update-btn').disabled = false;

                // 存储查询结果供后续使用
                window.lastQueryResult = userData;

                showResult('query-result', true, {
                    uid: uid,
                    data: userData,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                showResult('query-result', false, error.message);
            }
        }

        // 填充查询结果到更新表单
        function fillUpdateForm() {
            if (!window.lastQueryResult) {
                showResult('update-result', false, '没有可用的查询结果');
                return;
            }

            const data = window.lastQueryResult;

            // 填充用户ID
            document.getElementById('update-uid').value = data.uid;

            // 填充排名数据
            if (data.rank) {
                document.getElementById('update-score').value = data.rank.score || '';
                document.getElementById('update-level').value = data.rank.level || '';
            }

            // 清空现有车辆表单
            document.getElementById('palace-car-container').innerHTML = '';

            // 填充殿堂车辆数据
            if (data.palace && Object.keys(data.palace).length > 0) {
                Object.entries(data.palace).forEach(([carId, carData]) => {
                    addPalaceCar(
                        carId,
                        carData.palace_scores,
                        carData.rank_score,
                        carData.season_best_rank_score
                    );
                });
            } else {
                // 如果没有车辆数据，添加一个空表单
                addPalaceCar();
            }

            showResult('update-result', true, '已从查询结果填充更新表单');
        }

        // 提交更新
        async function submitCombinedUpdate() {
            const uid = document.getElementById('update-uid').value.trim();
            const score = document.getElementById('update-score').value;
            const level = document.getElementById('update-level').value;
            const carItems = document.querySelectorAll('#palace-car-container .car-item');

            if (!uid) {
                showResult('update-result', false, '请输入用户ID');
                return;
            }

            const updateData = {
                uid: uid,
                rank: {},
                palace: {}
            };

            // 处理排名更新
            if (score || level) {
                updateData.rank = {
                    score: score ? parseInt(score) : null,
                    level: level ? parseInt(level) : null
                };
            }

            // 处理殿堂分数更新
            if (carItems.length > 0) {
                const updates = {};
                let hasError = false;

                carItems.forEach(item => {
                    const carId = item.querySelector('.car-select').value;
                    const scores = Array.from(item.querySelectorAll('.palace-score')).map(
                        input => input.value === '' ? null : parseInt(input.value)
                    );
                    const rankScore = item.querySelector('.rank-score').value || null;
                    const seasonBestRank = item.querySelector('.season-best-rank').value || null;

                    if (!carId) {
                        showResult('update-result', false, '请选择车辆');
                        hasError = true;
                        return;
                    }

                    updates[carId] = {
                        palace_scores: scores,
                        rank_score: rankScore !== null ? parseInt(rankScore) : null,
                        season_best_rank_score: seasonBestRank !== null ? parseInt(seasonBestRank) : null
                    };
                });

                if (hasError) return;
                updateData.palace = updates;
            }

            if (Object.keys(updateData.rank).length === 0 && Object.keys(updateData.palace).length === 0) {
                showResult('update-result', false, '请至少填写一项更新内容');
                return;
            }

            try {
                // 模拟更新数据库
                if (!mockDatabase.users[uid]) {
                    mockDatabase.users[uid] = { uid: uid };
                }

                if (updateData.rank) {
                    mockDatabase.users[uid].rank = {
                        ...mockDatabase.users[uid].rank,
                        ...updateData.rank
                    };
                }

                if (updateData.palace) {
                    if (!mockDatabase.users[uid].palace) {
                        mockDatabase.users[uid].palace = {};
                    }

                    Object.entries(updateData.palace).forEach(([carId, data]) => {
                        mockDatabase.users[uid].palace[carId] = {
                            ...mockDatabase.users[uid].palace[carId],
                            ...data
                        };
                    });
                }

                showResult('update-result', true, {
                    message: `用户 ${uid} 数据更新成功！`,
                    updated_data: updateData,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                showResult('update-result', false, error.message);
            }
        }

        // 显示结果函数
        function showResult(elementId, success, data) {
            const element = document.getElementById(elementId);
            element.className = success ? 'response success' : 'response error';
            element.innerHTML = typeof data === 'string'
                ? data
                : `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // 初始化添加一辆车
        document.addEventListener('DOMContentLoaded', () => {
            addPalaceCar();
        });
    </script>
</body>
</html>